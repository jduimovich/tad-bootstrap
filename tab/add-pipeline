SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )" 
source $SCRIPTDIR/configure  
CMD=$(basename $0)
 
TAB_REPO=$(git config --get remote.origin.url)   
TAB_COMPONENT=$(basename $TAB_REPO)

PIPELINE_TYPE="${1:-docker}" 
TAB_IMAGE="${2:-quay.io/jduimovich0/$TAB_COMPONENT}"
NS=$(oc project --short)
TAB_NS="${3:-$NS}" 
TAB_APP="${4:-unknown-app}"  

if test -f Dockerfile; then 
     TAB_DOCKERFILE_LOCATION=Dockerfile 
else
     if test -f docker/Dockerfile; then 
          TAB_DOCKERFILE_LOCATION=docker/Dockerfile
     else 
          echo "No dockerfile"
          exit 0
     fi
fi  
TAB_BUILD_CONTEXT=.  

cp -r $PIPELINES_DIR/$PIPELINE_TYPE $ROOT/.tekton/   
cp -r $PIPELINES_DIR/repository.yaml $ROOT/.tekton/repository.yaml   

echo " {{values.image}} = $TAB_IMAGE"
echo " {{values.repoURL}} = $TAB_REPO"
echo " {{values.dockerfileLocation}} = $TAB_DOCKERFILE_LOCATION"
echo " {{values.buildContext}} = $TAB_BUILD_CONTEXT"
echo " {{values.appName}} = $TAB_APP"
echo " {{values.name}} = $TAB_COMPONENT" 
echo " {{values.namespace}} = $TAB_NS" 

for file in "$ROOT/.tekton/*"
do  
     sed -i s!{{values.image}}!$TAB_IMAGE!g $file  
     sed -i s!{{values.repoURL}}!$TAB_REPO!g $file  
     sed -i s!{{values.dockerfileLocation}}!$TAB_DOCKERFILE_LOCATION!g $file  
     sed -i s!{{values.buildContext}}!$TAB_BUILD_CONTEXT!g $file  
     sed -i s!{{values.appName}}!$TAB_APP!g $file  
     sed -i s!{{values.name}}!$TAB_COMPONENT!g $file  
     sed -i s!{{values.namespace}}!$TAB_NS!g $file  
done
 
git add .
git commit -m "Added Pipelines"
git push 
oc apply -f $TEKTON/repository.yaml
 
 