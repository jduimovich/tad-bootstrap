# installer type component namespace image

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )" 
source $SCRIPTDIR/configure  
 
ARGOREPONAME=$REPO_NAME.git  
TYPE=$1
CNAME=$2 
IMAGE=$3 

if test -d $TEMPLATE_DIR/$TYPE; then 
    echo "Initializing $TYPE component $APP_NAME:$CNAME in $APP_NS from template"
    echo "Setting deploy image to $IMAGE" 
    echo "Templates from $TEMPLATE_DIR"
else 
    echo $TYPE is an invalid template type in $TEMPLATE_DIR
    exit 0
fi 

echo "Copy Template for $TYPE from  $TEMPLATE_DIR/$TYPE into $COMPONENTS_PATH"
mkdir -p $COMPONENTS_PATH
cp -r $TEMPLATE_DIR/$TYPE $COMPONENTS_PATH/$CNAME/   # cp from template to component name 

BASE=$COMPONENTS_PATH/$CNAME/base/* 
sed -i s/{{component-name}}/$CNAME/g $BASE
sed -i s/{{component-namespace}}/$APP_NS/g  $BASE
sed -i s!{{component-image}}!$IMAGE!g  $BASE
sed -i s!{{component-repo}}!$ARGOREPONAME!g  $BASE
sed -i s/{{application-name}}/$APP_NAME/g  $BASE
 
CPATH=components/$CNAME/overlays/development 
DEV=$CPATH/*
sed -i s/{{component-name}}/$CNAME/g $DEV
sed -i s/{{component-namespace}}/$APP_NS/g $DEV
sed -i s!{{component-image}}!$IMAGE!g  $DEV
sed -i s/{{application-name}}/$APP_NAME/g $DEV




echo "Creating Application in <$REPO_FORMAT> ArgoCD App format"
if [ "$REPO_FORMAT" == "single" ]; then  
    ARGOAPP=$APPS_ROOT/$APP_NAME.yaml 
    SINGLE_APP_KUSTOMIZE_ROOT=$APPS_ROOT/components-root
    if test -f $ARGOAPP; then
        echo "ArgoCD Root Exists"  
    else 
        cp  $TEMPLATE_DIR/application.yaml  $ARGOAPP
        sed -i s/{{component-name}}/$APP_NAME/g $ARGOAPP
        sed -i s/{{component-namespace}}/$APP_NS/g $ARGOAPP
        sed -i s!{{component-repo}}!$ARGOREPONAME!g  $ARGOAPP  
        sed -i s!{component-path}!$SINGLE_APP_KUSTOMIZE_ROOT!g  $ARGOAPP 
    fi
    rm -rf $SINGLE_APP_KUSTOMIZE_ROOT 
    mkdir -p $SINGLE_APP_KUSTOMIZE_ROOT
    KUST=$SINGLE_APP_KUSTOMIZE_ROOT/kustomization.yaml
    echo "apiVersion: kustomize.config.k8s.io/v1beta1" >$KUST
    echo "kind: Kustomization" >>$KUST
    echo "resources:" >>$KUST  
    for i in $COMPONENTS_ROOT/* 
    do
        CNAME=$(basename $i) 
        CPATH="- ../../$COMPONENTS_ROOT/$CNAME/overlays/development" 
        echo "$CPATH" >>$KUST 
    done 
else 
    ARGOAPP=$APPS_ROOT/$CNAME.yaml 
    cp  $TEMPLATE_DIR/application.yaml  $ARGOAPP
    sed -i s/{{component-name}}/$APP_NAME-$CNAME/g $ARGOAPP
    sed -i s/{{component-namespace}}/$APP_NS/g $ARGOAPP
    sed -i s!{{component-repo}}!$ARGOREPONAME!g  $ARGOAPP 
    sed -i s!{component-path}!$CPATH!g  $ARGOAPP 
fi 
