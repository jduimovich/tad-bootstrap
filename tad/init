SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )" 
ROOT=$(pwd) 
FORMAT="${1:-single}"
#contents will be in COMPONENTS_ROOT 
REPO_NAME=$(git config --get remote.origin.url)   
if [ "$REPO_NAME" == "" ]; then 
    echo "This repo is has no remote."
    echo "Create on github and connect remote here."
    BASE_REPO=$(basename $ROOT)
    
    echo "Run this to create $BASE_REPO in github" 
    echo 
    echo "gh repo create $BASE_REPO --public" 
    echo "Gitops Repo Bootstrapped" > README.md
    echo "git add README.md"
    echo "git commit -m \"Gitops Repo Bootstrapped\"" 
    echo "git branch -M main"
    echo "git remote add origin https://github.com/$MY_GITHUB_USER/$BASE_REPO"
    echo "git push -u origin main"  
    echo 
    exit 0
fi   

# local patch from root 
APPS_ROOT=apps 
COMPONENTS_ROOT=components 
PROPS=$ROOT/$APPS_ROOT/tad.properties
APP_NAME=$(basename $REPO_NAME .git)  
APP_NS=$APP_NAME
 
if test -d $ROOT/$APPS_ROOT; then 
    if [ "$(ls -A $PROPS)" ]; then
        echo  
        echo "$ROOT is already a Gitops Repository"
        echo  
        exit 0 
    fi 
else
    mkdir -p $APPS_ROOT
    mkdir -p $COMPONENTS_ROOT
    touch $PROPS
    echo "export REPO_NAME=$REPO_NAME" >>$PROPS
    echo "export APP_NAME=$APP_NAME" >>$PROPS 
    echo "export APP_NS=$APP_NS" >>$PROPS 

    #local path names 
    echo "export APPS_ROOT=$APPS_ROOT" >>$PROPS 
    echo "export COMPONENTS_ROOT=$COMPONENTS_ROOT" >>$PROPS 
    echo "export AUTO_UPDATE_CLUSTER=true" >>$PROPS 
    echo "export REPO_FORMAT=$FORMAT" >>$PROPS 

    # fully qualified names 
    echo "export APPS_PATH=$ROOT/$APPS_ROOT" >>$PROPS 
    echo "export COMPONENTS_PATH=$ROOT/$COMPONENTS_ROOT" >>$PROPS  
    echo "export SINGLE_APP_KUSTOMIZE_ROOT=$APPS_ROOT/components-root" >>$PROPS  
    
    echo "Initialized Gitops Repo: $REPO_NAME"
fi  
