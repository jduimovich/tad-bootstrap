# installer type component namespace image

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )" 
ROOT=$(realpath $SCRIPTDIR/..) 

REPONAME=$(git config --get remote.origin.url)  
ARGOREPONAME=$REPONAME.git
APPNAME=$(basename $REPONAME .git) 
TYPE=$1
CNAME=$2
NS=$3
IMAGE=$4 
echo "Initializing $TYPE component $APPNAME:$CNAME in $NS from template"
echo "Setting deploy image to $IMAGE"
  
echo "Copy Template for $TYPE from  $ROOT/templates/$TYPE into $ROOT/components/$TYPE/"
mkdir -p $ROOT/components
cp -r $ROOT/templates/$TYPE $ROOT/components/$CNAME/   # cp from template to component name 

BASE=$ROOT/components/$CNAME/base/* 
sed -i s/{component-name}/$CNAME/g $BASE
sed -i s/{component-namespace}/$NS/g  $BASE
sed -i s!{image-name}!$IMAGE!g  $BASE
sed -i s/{application-name}/$APPNAME/g  $BASE
 
CPATH=components/$CNAME/overlays/development 
DEV=$CPATH/*
sed -i s/{component-name}/$CNAME/g $DEV
sed -i s/{component-namespace}/$NS/g $DEV
sed -i s!{image-name}!$IMAGE!g  $DEV
sed -i s/{application-name}/$APPNAME/g $DEV

ARGOAPP=$ROOT/components/$CNAME.yaml 
cp  $ROOT/templates/application.yaml  $ARGOAPP
sed -i s/{component-name}/$CNAME/g $ARGOAPP
sed -i s/{component-namespace}/$NS/g $ARGOAPP
sed -i s!{this-repo}!$ARGOREPONAME!g  $ARGOAPP 
sed -i s!{component-path}!$CPATH!g  $ARGOAPP 
 